name: Code Coverage Main App, Shared & Extension

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer

jobs:
  test-and-coverage:
    runs-on: macos-26
    name: Tests & Coverage

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app
          xcodebuild -version
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Reset simulators
        run: |
          xcrun simctl shutdown all
          xcrun simctl erase all
          xcrun simctl list runtimes
      - name: Recreate simulator
        run: |
          xcrun simctl shutdown all
          xcrun simctl delete unavailable

          RUNTIME=$(xcrun simctl list runtimes | grep "iOS 26.2" | awk '{print $NF}')
          echo "Runtime: $RUNTIME"
          DEVICE_ID=$(xcrun simctl create "CI-iPhone" "iPhone 17" "$RUNTIME")

          echo "Created simulator $DEVICE_ID"

      - name: Install Bundler & Dependencies
        run: |
          gem install bundler
          bundle install

      - name: List Xcode versions
        run: ls /Applications | grep Xcode

      - name: Show available destinations
        run: |
          xcodebuild -showdestinations \
            -workspace "Listen anonymously.xcodeproj/project.xcworkspace" \
            -scheme "Listen anonymously Ext Tests" | grep "CI-iPhone"

      - name: Run Tests via Fastlane (with Coverage)
        run: |
          echo "DEV_TEAM_SECRET=${{ secrets.DEV_TEAM_SECRET }}" > Configuration/Secrets.xcconfig
          bundle exec fastlane all_tests

      # ---- Coverage processing (fast + readable) ----
      - name: Generate Coverage (Cobertura)
        run: |
          brew install a7ex/homebrew-formulae/xcresultparser

          # Adjust path if Fastlane outputs elsewhere
          XCRESULT=$(find . -name "*.xcresult" | head -n 1)

          echo "Using xcresult: $XCRESULT"

          xcresultparser \
            --output-format cobertura \
            "$XCRESULT" > coverage.xml

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          flags: ios
          name: ios-fastlane-coverage

      # ---- Super quick inspection ----
      - name: Upload Test Results (.xcresult)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcresult
          path: |
            **/*.xcresult

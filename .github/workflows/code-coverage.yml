name: Code Coverage Main App, Shared & Extension

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  test-and-coverage:
    runs-on: macos-latest
    name: Tests & Coverage

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s "$DEVELOPER_DIR"
          xcodebuild -version

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install Bundler & Dependencies
        run: |
          gem install bundler
          bundle install

      - name: Run Tests via Fastlane (with Coverage)
        run: |
          bundle exec fastlane all_tests

      # ---- Coverage processing (fast + readable) ----
      - name: Generate Coverage (Cobertura)
        run: |
          brew install a7ex/homebrew-formulae/xcresultparser

          # Adjust path if Fastlane outputs elsewhere
          XCRESULT=$(find . -name "*.xcresult" | head -n 1)

          echo "Using xcresult: $XCRESULT"

          xcresultparser \
            --output-format cobertura \
            "$XCRESULT" > coverage.xml

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          flags: ios
          name: ios-fastlane-coverage

      # ---- Super quick inspection ----
      - name: Upload Test Results (.xcresult)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcresult
          path: |
            **/*.xcresult
